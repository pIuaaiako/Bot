import os
import io
import asyncio
import aiohttp
from datetime import datetime
import sys

# Attempt a clean import of python-telegram-bot
try:
    from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
    from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, CallbackQueryHandler, MessageHandler, filters, ConversationHandler
except ImportError:
    # Fallback to absolute imports if needed
    import telegram
    from telegram._update import Update
    from telegram._inlinekeyboardbutton import InlineKeyboardButton
    from telegram._inlinekeyboardmarkup import InlineKeyboardMarkup
    from telegram.ext._applicationbuilder import ApplicationBuilder
    from telegram.ext._commandhandler import CommandHandler
    from telegram.ext._callbackqueryhandler import CallbackQueryHandler
    from telegram.ext._messagehandler import MessageHandler
    from telegram.ext._conversationhandler import ConversationHandler
    import telegram.ext._filters as filters

# ================== CONFIG ==================
TELEGRAM_TOKEN = "7249053204:AAGvad3x2mdYDb-AC1iKjz7eMSfUfRc_1tQ"
API_URL = "http://45.141.27.74:24391/dump.php"
API_KEY = "dinoshop_M4kHn3pVqS"
CREDIT_NAME = "DinoShop"

# States for ConversationHandler
KEYWORD, MODE = range(2)

# ================== API UTILS ==================
async def query_api(keyword: str, t: int = 1) -> dict:
    params = {"q": keyword, "t": t, "key": API_KEY}
    async with aiohttp.ClientSession() as session:
        async with session.get(API_URL, params=params) as resp:
            if resp.status != 200:
                raise RuntimeError(f"HTTP {resp.status}")
            return await resp.json(content_type=None)

def split_bytes(data: bytes, filename: str, max_mb: int = 45) -> list:
    """Split data into chunks if it exceeds Telegram's file size limit (50MB usually, safe 45MB)."""
    max_b = max_mb * 1024 * 1024
    if len(data) <= max_b:
        return [(filename, io.BytesIO(data))]
    
    files = []
    part = 1
    for i in range(0, len(data), max_b):
        chunk = data[i:i + max_b]
        files.append((f"{os.path.splitext(filename)[0]}_part{part}.txt", io.BytesIO(chunk)))
        part += 1
    return files

def safe_filename(name: str) -> str:
    return "".join(c if c.isalnum() or c in "._-" else "_" for c in name)

# ================== HANDLERS ==================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search)", callback_data='search')],
        [InlineKeyboardButton("üìò ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Help)", callback_data='help')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_msg = (
        "ü§ñ **DinoDonut Telegram Bot**\n\n"
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Log ‡∏ú‡πà‡∏≤‡∏ô DinoDonut\n"
        "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
    )
    
    if update.message:
        await update.message.reply_text(welcome_msg, reply_markup=reply_markup, parse_mode='Markdown')
    elif update.callback_query:
        await update.callback_query.message.edit_text(welcome_msg, reply_markup=reply_markup, parse_mode='Markdown')

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == 'search':
        await query.message.reply_text("üîé ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå **‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Keyword)** ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:\n(‡πÄ‡∏ä‡πà‡∏ô `pointblank.zepetto.com`)", parse_mode='Markdown')
        return KEYWORD
    
    elif query.data == 'help':
        help_text = (
            "üìñ **‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô**\n"
            "1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤\n"
            "2. ‡∏û‡∏¥‡∏°‡∏û‡πå Keyword ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£\n"
            "3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î (0 ‡∏´‡∏£‡∏∑‡∏≠ 1) ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (1)\n"
            "4. ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏≤‡∏á‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ"
        )
        # Add back button
        keyboard = [[InlineKeyboardButton("üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", callback_data='back')]]
        await query.message.edit_text(help_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='Markdown')
        return ConversationHandler.END

    elif query.data == 'back':
        await start(update, context)
        return ConversationHandler.END

async def get_keyword(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyword = update.message.text.strip()
    context.user_data['keyword'] = keyword
    
    await update.message.reply_text(
        f"‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: `{keyword}`\n\n"
        "üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ **‡πÇ‡∏´‡∏°‡∏î (Mode)** (0 ‡∏´‡∏£‡∏∑‡∏≠ 1):\n"
        "_(‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 0 ‡∏´‡∏£‡∏∑‡∏≠ 1, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå 'ok' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1)_",
        parse_mode='Markdown'
    )
    return MODE

async def get_mode_and_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    mode_input = update.message.text.strip()
    mode = 1
    if mode_input in ['0', '1']:
        mode = int(mode_input)
    
    keyword = context.user_data.get('keyword')
    
    status_msg = await update.message.reply_text(f"‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ `{keyword}` (‡πÇ‡∏´‡∏°‡∏î {mode})...", parse_mode='Markdown')
    
    try:
        start_time = datetime.now()
        js = await query_api(keyword, mode)
        
        if js.get("status") != "success":
            await status_msg.edit_text(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {js.get('message')}")
            return ConversationHandler.END

        lines = js.get("data", [])
        elapsed = (datetime.now() - start_time).total_seconds() * 1000
        filename = f"{safe_filename(keyword)}.txt"
        
        summary = (
            f"‚úÖ **‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!**\n"
            f"‚Ä¢ ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô: `{keyword}`\n"
            f"‚Ä¢ ‡πÇ‡∏´‡∏°‡∏î: `{mode}`\n"
            f"‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: `{len(lines):,}` ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î\n"
            f"‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: `{elapsed:.2f} ms`\n"
            f"‚Ä¢ ‡πÇ‡∏î‡∏¢: {CREDIT_NAME}"
        )
        
        await status_msg.edit_text(summary, parse_mode='Markdown')
        
        # Prepare and send file(s)
        content = "\n".join(lines).encode("utf-8")
        files_to_send = split_bytes(content, filename)
        
        for name, bio in files_to_send:
            bio.seek(0)
            await update.message.reply_document(document=bio, filename=name, caption=f"üìÇ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: {keyword}")
            
    except Exception as e:
        await status_msg.edit_text(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}")
        
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text('‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", callback_data='back')]]))
    return ConversationHandler.END

# ================== MAIN ==================
def main():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    # Conversation Handler for Search Flow
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(button_handler, pattern='^search$')],
        states={
            KEYWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_keyword)],
            MODE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_mode_and_search)],
        },
        fallbacks=[CommandHandler('cancel', cancel), CallbackQueryHandler(button_handler, pattern='^back$')]
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("panel", start)) # Alias for panel
    app.add_handler(CallbackQueryHandler(button_handler, pattern='^help$|^back$'))
    app.add_handler(conv_handler)

    print("‚úÖ Bot is running...")
    app.run_polling()

if __name__ == "__main__":
    main()
